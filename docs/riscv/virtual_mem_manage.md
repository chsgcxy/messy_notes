# RISCV虚拟内存管理

[TOC]

RISCV仍然使用分页机制来进行虚拟内存管理。页表的本质是一种高基数树，按照分页方案不同，具有不同级数的树结构。

RISCV的分页方案以 SvX 的模式命名,其中 X 是虚拟地址的长度， Sv32则代表32bit虚拟地址的分页方案。

分页机制是由S模式提供的

## 名词解释

**PPN**(Physical Page Number)
**VPN**(Virtual Page Number)
**ASID**(Address Space Identifier)

## Sv32分页方案

Sv32页表项(PTE)构成:

31-20 | 19-10 | 9-8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0
|--|--|--|--|--|--|--|--|--|--|--
PPN1| PPN0 | RSW | D | A | G | U | X | W | R | V

Sv32 支持4GB虚拟地址空间，分为两级。第一级叫做巨页， 4GB被划分为1024个4MB的巨页；第二级叫做基页，每个4MB的巨页被划分为1024个4KB的基页。一个页表项由4字节(32bit)构成，则一张页表刚好被一个基页所容纳。

因此，使用1025个基页完成了4GB虚拟地址到物理地址的映射

## Sv39分页方案

采用同样的思路，保持一张页表刚好等于一个基页的大小。Sv39采用三层树结构，每层有512个页表项，每个页表项占用8字节(64bit)，这样仍然保持了4KB的基页大小，也同时保持一张页表刚好占用一个基页。

## 地址转换过程

这里以Sv32为例来说明地址转换过程

**satp**(Supervisor Address Translation and Protection)
寄存器控制了分页系统方案

satp寄存器字段如下:
31 | 30 - 22 | 21 - 0
--|--|--
MODE | ASID | PPN

对于RV32来讲，satp的MODE字段只占1bit, 即只有启用Sv32和关闭两个选择；而RV64除了Sv39还有Sv48。

ASID降低上下文切换的开销,但具体机制后续了解了再补充吧

PPN为一级页表所在的物理页号

当CPU发出一个如下的虚拟地址
31 - 22 | 21 - 12 | 11 - 0
--|--|--
VPN[1] | VPN[0] | offset

CPU首先查看satp寄存器，从中获取PNN，即一级页表物理地址。
虚拟地址中的VPN[1]指示了一级页表表项的编号，每一个表项占4个字节。则该虚拟地址对应的一级页表项地址为satp.PPN × 4096 + VPN[1] × 4

为了描述方便，将一级页表项中的PPN[1]与PPN[0]合称为PPN,那么该页表项中的PPN指示了二级页表的物理地址。虚拟地址中的VPN[0]指示了二级页表项的编号，没一个表项占4字节。则该虚拟地址对应的二级页表项地址为PTE. PPN × 4096 + VPN[0] × 4

二级页表项的 PPN 字段和虚拟地址中的offset组成了最
终的该虚拟地址对应的物理地址LeafPTE.PPN × 4096 + offset

