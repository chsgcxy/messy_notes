# 乱序CPU的寄存器重命名(Register Renaming)机制

在乱序CPU中，寄存器重命名是非常重要的一个机制，它在CPU乱序执行时，主要有两个作用

- 消除指令之间的反向依赖问题（读后写依赖（WAR）和写后写依赖（WAW））
- 当指令执行发生异常或分支预测错误而取消后面的指令时可以保证现场还原的准确

实现思路就是执行指令时不直接操作架构寄存器，而是先操作一个与架构寄存器有映射关系的中间寄存器，当这条指令提交的时候再写到架构寄存器中。
当然，这个思路的描述不一定准确，因为随着乱序CPU的发展，Register Renaming的实现方式也在发展。
不同的CPU，其内部的Register Renaming实现可能会存在差异，有的物理寄存器和指令集寄存器是独立的，有的是合并成一个寄存器堆。还有一些分类中
分为显式重命名机制和隐式重命名机制。这些需要我们具体的CPU架构具体分析。

总结一下，就是在不增加指令集寄存器的前提下（可以理解为软件无感），用更多的寄存器来解决乱序执行时的寄存器反向依赖问题。

## 工作原理

假如我们有如下代码

```asm
lw x2, 0(x1);
add x3, x2, x4;
sub x2, x4, x5;
```

假设我们的CPU是单发射顺序CPU，有五级流水线，那么当lw指令发生DCache未命中时，流水线大致是这样的:

