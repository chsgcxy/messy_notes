# 利用Trace进行性能分析

前面已经总结过借助google的tracing来进行性能分析的方法[使用chrome-tracing工具查看性能分析log](../tools/chrome-tracing.md)。最近需要让芯片验证的同事提供一些仿真的trace，以便进行性能分析。芯片验证同事却不知道应该提供怎样的trace, 我也没法比较详细的给他进行描述，一是因为trace必然要具体问题具体分析，笼统的指导意见很难落地。二是我自己对此也没有一个好的总结。所以把之前做的一些trace在这里借机做一些总结，以便后续能够提供一套相对普适的方法和工具来做trace的性能分析。

## 核心思想

- trace采用事件的形式，以指令为对象，记录指令在某个cycle触发了怎样的事件，以此来分析性能优化的可能性。
- 指令要有全局唯一的ID(比如说PC)来识别(在有些结构中可能不保存全局唯一ID, 这时要找到转换的位置，建立全局唯一ID与模块ID的关系)
- 事件类型参考google tracing提供的事件格式来制定，分为两个大类, instant event and duration event
- 尽可能的保证生成的json文件只针对某一个具体的问题。大而全的json文件看起来是很头疼的，我们需要针对具体问题生成不同的json文件，用来对某个具体的性能问题做分析。

## 过程中遇到的问题

### 显示顺序问题

在实际操作过程中，遇到了一个问题，找到了一个简单的解决方法：

tracing是按照时间进行解析的，也就是说，哪个pid先出现，先显示哪个。往往我们在调试CPU时，希望按照一定的单元顺序来排列会更好。那么我们可以利用instant event，在第0个cycle，按照我们想要的顺序来排列pid.
这样在显示的时候会更加友好

### trace解析问题

对于在rtl中增加的trace打印，往往不会是按照事件来打印的，可能进buffer的这个动作在好几个cycle中都有打印，我们需要在解析时做一些融合。
