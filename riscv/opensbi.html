
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Chsgcxy">
      
      
        <link rel="canonical" href="https://chsgcxy.github.io/messy_notes/riscv/opensbi.html">
      
      
        <link rel="prev" href="la.html">
      
      
        <link rel="next" href="pma.html">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>OpenSBI - Messy Notes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#opensbi" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="Messy Notes" class="md-header__button md-logo" aria-label="Messy Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Messy Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OpenSBI
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/chsgcxy/messy_notes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Messy Notes" class="md-nav__button md-logo" aria-label="Messy Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Messy Notes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/chsgcxy/messy_notes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Welcome To Messy Notes
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" tabindex="0" aria-expanded="false">
          Arch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Arch" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Arch
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/arch_demo.html" class="md-nav__link">
        XS Arch simple
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/arch_design.html" class="md-nav__link">
        芯片架构设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/arm_training_day1.html" class="md-nav__link">
        ARM Training Day1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/arm_training_day2.html" class="md-nav__link">
        ARM Training Day2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/atomic.html" class="md-nav__link">
        RISCV原子操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/cache.html" class="md-nav__link">
        Cache之我见
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/chiplet.html" class="md-nav__link">
        chiplet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/computer_arch.html" class="md-nav__link">
        计算机体系结构量化研究方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/hotchip33.html" class="md-nav__link">
        hotchip33
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/numa.html" class="md-nav__link">
        numa架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/register_rename.html" class="md-nav__link">
        乱序CPU的寄存器重命名(Register Renaming)机制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/rob.html" class="md-nav__link">
        ROB模块
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/superscalar.html" class="md-nav__link">
        超标量处理器设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/think1.html" class="md-nav__link">
        一个微架构设计引发的思考
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/tlb.html" class="md-nav__link">
        TLB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/vector.html" class="md-nav__link">
        各家向量指令扩展
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_17" type="checkbox" id="__nav_2_17" >
      
      
      
        <label class="md-nav__link" for="__nav_2_17" tabindex="0" aria-expanded="false">
          Hotchip33
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Hotchip33" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_17">
          <span class="md-nav__icon md-icon"></span>
          Hotchip33
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/hotchip33/hotchip33.html" class="md-nav__link">
        hotchip33
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" tabindex="0" aria-expanded="false">
          C
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="C" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          C
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/cast.html" class="md-nav__link">
        搞清楚各种cast
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/complement.html" class="md-nav__link">
        补码经典案例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/cplus.html" class="md-nav__link">
        C++操作符重载
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/cpp-param-pack.html" class="md-nav__link">
        c++ parameter pack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/gcc_tools.html" class="md-nav__link">
        GCC 工具及相关介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/int_uint.html" class="md-nav__link">
        符号扩展
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/lvalue_and_rvalue.html" class="md-nav__link">
        引用，左值，右值
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/makefile.html" class="md-nav__link">
        makefile语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/omp.html" class="md-nav__link">
        多线程编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/reverse.html" class="md-nav__link">
        如何写一个又高效又美观的reverse
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../c/stl_containers.html" class="md-nav__link">
        C++ STL容器
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" tabindex="0" aria-expanded="false">
          Chisel
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chisel" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Chisel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chisel/chisel.html" class="md-nav__link">
        chisel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chisel/rocketchip.html" class="md-nav__link">
        rocket chip分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chisel/sbt.html" class="md-nav__link">
        sbt
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chisel/scala.html" class="md-nav__link">
        scala
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" tabindex="0" aria-expanded="false">
          Debug
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Debug" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Debug
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../debug/objcopy.html" class="md-nav__link">
        objcopy
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" tabindex="0" aria-expanded="false">
          Deeplearning
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Deeplearning" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Deeplearning
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeplearning/bert.html" class="md-nav__link">
        Bert(Bidirectional Encoder Representations from Transformers)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeplearning/deeplearning.html" class="md-nav__link">
        deeplearning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeplearning/onehot.html" class="md-nav__link">
        one-hot
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" tabindex="0" aria-expanded="false">
          Design patterns
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Design patterns" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Design patterns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../design-patterns/design-patterns.html" class="md-nav__link">
        design-patterns
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" tabindex="0" aria-expanded="false">
          Ic
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ic" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Ic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ic/axi4.html" class="md-nav__link">
        AXI4
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ic/cordic.html" class="md-nav__link">
        硬件三角函数算法CORDIC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ic/esl.html" class="md-nav__link">
        ESL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ic/ic_develop.html" class="md-nav__link">
        IC设计与开发流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ic/pcie.html" class="md-nav__link">
        PCIE
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ic/qemu.html" class="md-nav__link">
        QEMU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ic/simulator.html" class="md-nav__link">
        模拟器之我见
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ic/simulator2.html" class="md-nav__link">
        再谈模拟器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ic/tlm.html" class="md-nav__link">
        TLM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ic/usb.html" class="md-nav__link">
        USB
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" tabindex="0" aria-expanded="false">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linux/arm-linux-kmodule-load.html" class="md-nav__link">
        arm linux 内核模块加载过程详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linux/kernel-status.html" class="md-nav__link">
        Kernel status
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linux/lzma_transplant.html" class="md-nav__link">
        transplant LZMA compression algo from linux2.6.32 to linux2.6.29
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linux/sync-and-exclusion.html" class="md-nav__link">
        Linux的同步和互斥机制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linux/syscall.html" class="md-nav__link">
        linux系统调用
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" tabindex="0" aria-expanded="false">
          Mcu
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Mcu" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Mcu
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mcu/ads7843.html" class="md-nav__link">
        ADS7843 无中断响应问题定位
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mcu/emwin_debug.html" class="md-nav__link">
        stm32f207 emwin + freertos 调试过程问题简要记录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mcu/fatfs_f_readdir.html" class="md-nav__link">
        f_readdir 在使用长文件名时的问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mcu/lpc1114_hex2bin.html" class="md-nav__link">
        LPC1114 使用USER命令实现hex转bin
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      
      
        <label class="md-nav__link" for="__nav_11" tabindex="0" aria-expanded="false">
          Misc
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Misc" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          Misc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/howtolearn.html" class="md-nav__link">
        学习技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/latex.html" class="md-nav__link">
        Latex
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/pcie.html" class="md-nav__link">
        基于linux 的 PCI & PCIe 总线分析总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/photograph.html" class="md-nav__link">
        摄影与视听基础理论
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/pytest.html" class="md-nav__link">
        pytest测试框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/randomx.html" class="md-nav__link">
        RandomX 简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/roadmap.html" class="md-nav__link">
        My Road Map
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/shell.html" class="md-nav__link">
        shell 小点总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/skiing.html" class="md-nav__link">
        Skiing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/vlog.html" class="md-nav__link">
        Vlog
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/words.html" class="md-nav__link">
        Words
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/work-201904-202102.html" class="md-nav__link">
        工作总结2019.04～2021.04
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/xmr.html" class="md-nav__link">
        XMR
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_12" type="checkbox" id="__nav_12" >
      
      
      
        <label class="md-nav__link" for="__nav_12" tabindex="0" aria-expanded="false">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Python" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python/env_requirement.html" class="md-nav__link">
        python 虚拟环境及依赖
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python/numpy_softfloat.html" class="md-nav__link">
        numpy 使用softfloat的方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python/python.html" class="md-nav__link">
        python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_13" type="checkbox" id="__nav_13" checked>
      
      
      
        <label class="md-nav__link" for="__nav_13" tabindex="0" aria-expanded="true">
          Riscv
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Riscv" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          Riscv
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="RISC-V.html" class="md-nav__link">
        RISC-V
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="la.html" class="md-nav__link">
        LA指令的理解
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          OpenSBI
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="opensbi.html" class="md-nav__link md-nav__link--active">
        OpenSBI
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-opensbi" class="md-nav__link">
    what is OpenSBI
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sbi" class="md-nav__link">
    SBI
  </a>
  
    <nav class="md-nav" aria-label="SBI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    工作机制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-its-needed" class="md-nav__link">
    why it's needed
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opensbi_1" class="md-nav__link">
    OpenSBI的实现
  </a>
  
    <nav class="md-nav" aria-label="OpenSBI的实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#opensbi_2" class="md-nav__link">
    假如我们设计OpenSBI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    参考资料
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pma.html" class="md-nav__link">
        PMA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="riscv-rvv.html" class="md-nav__link">
        RISCV向量扩展实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="riscv-torture.html" class="md-nav__link">
        riscv-torture 总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="virtual_mem_manage.html" class="md-nav__link">
        RISCV虚拟内存管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="wfi.html" class="md-nav__link">
        wfi遇到的问题
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_14" type="checkbox" id="__nav_14" >
      
      
      
        <label class="md-nav__link" for="__nav_14" tabindex="0" aria-expanded="false">
          Simulator
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Simulator" data-md-level="1">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          Simulator
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simulator/dramsim_ddr.html" class="md-nav__link">
        DDR and DRAMSim3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simulator/gem5-se.html" class="md-nav__link">
        gem5的SE模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simulator/gem5.html" class="md-nav__link">
        GEM5 设计与实现分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simulator/gem5_introduction.html" class="md-nav__link">
        Gem5 Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simulator/gem5_isa.html" class="md-nav__link">
        Gem5指令集框架解析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simulator/gem5_o3cpu.html" class="md-nav__link">
        O3CPU 代码分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simulator/gem5_random.html" class="md-nav__link">
        单核双发射5级流水CPU的IPC性能分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simulator/simplesim.html" class="md-nav__link">
        simpleScalar解析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simulator/spike.html" class="md-nav__link">
        从spike分析一款模拟器的设计与实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simulator/trace_format.html" class="md-nav__link">
        利用Trace进行性能分析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_15" type="checkbox" id="__nav_15" >
      
      
      
        <label class="md-nav__link" for="__nav_15" tabindex="0" aria-expanded="false">
          Smt pnp
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Smt pnp" data-md-level="1">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          Smt pnp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../smt-pnp/smt-pnp-introduction.html" class="md-nav__link">
        SMT-PNP 笔记
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_16" type="checkbox" id="__nav_16" >
      
      
      
        <label class="md-nav__link" for="__nav_16" tabindex="0" aria-expanded="false">
          Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tools" data-md-level="1">
        <label class="md-nav__title" for="__nav_16">
          <span class="md-nav__icon md-icon"></span>
          Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/arm-atp.html" class="md-nav__link">
        ATP(Adaptive Traffic Profiles)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/cache-size.html" class="md-nav__link">
        cache大小测试工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/chrome-tracing.html" class="md-nav__link">
        使用chrome-tracing工具查看性能分析log
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/cii-and-crontable.html" class="md-nav__link">
        自动化部署之gitlab.ci 和 crontable
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/engine.html" class="md-nav__link">
        engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/git-hooks.html" class="md-nav__link">
        git 钩子与自动编码风格检查
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/git.html" class="md-nav__link">
        git技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/llvm-symbolizer.html" class="md-nav__link">
        使用llvm-symbolizer查找符号
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/markdown.html" class="md-nav__link">
        How to use markdown with vscode
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/ntfs-mount.html" class="md-nav__link">
        移动硬盘 Ubuntu挂载问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/perf.html" class="md-nav__link">
        linux性能统计工具使用总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/protobuf.html" class="md-nav__link">
        protobuf
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/screen.html" class="md-nav__link">
        screen
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/stream.html" class="md-nav__link">
        评估DDR通道数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/vscode-remotessh.html" class="md-nav__link">
        vscode
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/wsl.html" class="md-nav__link">
        WSL
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_17" type="checkbox" id="__nav_17" >
      
      
      
        <label class="md-nav__link" for="__nav_17" tabindex="0" aria-expanded="false">
          Tvm
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tvm" data-md-level="1">
        <label class="md-nav__title" for="__nav_17">
          <span class="md-nav__icon md-icon"></span>
          Tvm
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tvm/codebase-struct.html" class="md-nav__link">
        directory-structure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tvm/node.html" class="md-nav__link">
        Node-SubSystem
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tvm/runtime.html" class="md-nav__link">
        runtime
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tvm/tvm-start.html" class="md-nav__link">
        tvm
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_18" type="checkbox" id="__nav_18" >
      
      
      
        <label class="md-nav__link" for="__nav_18" tabindex="0" aria-expanded="false">
          Verilog
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Verilog" data-md-level="1">
        <label class="md-nav__title" for="__nav_18">
          <span class="md-nav__icon md-icon"></span>
          Verilog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../verilog/round_robin_algo.html" class="md-nav__link">
        一种round_robin算法实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../verilog/verilog1.html" class="md-nav__link">
        verilog第一篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../verilog/verilog2.html" class="md-nav__link">
        verilog第二篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../verilog/verilog3.html" class="md-nav__link">
        verilog 第三篇
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-opensbi" class="md-nav__link">
    what is OpenSBI
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sbi" class="md-nav__link">
    SBI
  </a>
  
    <nav class="md-nav" aria-label="SBI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    工作机制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-its-needed" class="md-nav__link">
    why it's needed
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opensbi_1" class="md-nav__link">
    OpenSBI的实现
  </a>
  
    <nav class="md-nav" aria-label="OpenSBI的实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#opensbi_2" class="md-nav__link">
    假如我们设计OpenSBI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    参考资料
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="opensbi">OpenSBI<a class="headerlink" href="#opensbi" title="Permanent link">&para;</a></h1>
<div class="toc">
<ul>
<li><a href="#opensbi">OpenSBI</a><ul>
<li><a href="#what-is-opensbi">what is OpenSBI</a></li>
<li><a href="#sbi">SBI</a><ul>
<li><a href="#_1">工作机制</a></li>
<li><a href="#why-its-needed">why it's needed</a></li>
</ul>
</li>
<li><a href="#opensbi_1">OpenSBI的实现</a><ul>
<li><a href="#opensbi_2">假如我们设计OpenSBI</a></li>
<li><a href="#_2">实现</a></li>
</ul>
</li>
<li><a href="#_3">参考资料</a></li>
</ul>
</li>
</ul>
</div>
<p>本文先介绍什么是OpenSBI, 再详解SBI的工作机制，最后对OpenSBI的代码框架进行分析。</p>
<h2 id="what-is-opensbi">what is OpenSBI<a class="headerlink" href="#what-is-opensbi" title="Permanent link">&para;</a></h2>
<p>OpenSBI是开源的RISC-V <a href="https://github.com/riscv-non-isa/riscv-sbi-doc">Supervisor Binary Interface</a> 软件参考实现。它是一个运行在更高特权等级，用来初始化硬件，并且允许操作系统等低特权等级软件调用它来实现设备重启或CPU核管理等操作的固件。</p>
<p>下图展示了一般的多级启动模型。CPU上电执行ROM中的代码，ROM加载SPL到内部SRAM，SPL加载RUNTIME，RUNTIME再加载BOOTLOADER，最后由BOOTLOADER加载OS</p>
<p><img alt="../imgs/common_boot_flow_multi_stage.PNG" src="../imgs/common_boot_flow_multi_stage.PNG" /></p>
<p>下图展示了RISCV的多级启动模型。只是中间的RUNTIME变成了OpenSBI。</p>
<p><img alt="../imgs/riscv_common_boot_flow_multi_stage.PNG" src="../imgs/riscv_common_boot_flow_multi_stage.PNG" /></p>
<p>总结来看，它有点儿像ARM体系中的ATF(Arm Trusted Firmware),甚至像pc领域的BIOS/UEFI。</p>
<h2 id="sbi">SBI<a class="headerlink" href="#sbi" title="Permanent link">&para;</a></h2>
<blockquote>
<p>The SBI allows supervisor-mode (S-mode or VS-mode) software to be portable across all RISC-V implementations by defining an abstraction for platform (or hypervisor) specific functionality.</p>
</blockquote>
<p>SBI能够提高S-mode软件的可移植性。</p>
<h3 id="_1">工作机制<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p><img alt="../imgs/riscv_opensbi_system.PNG" src="../imgs/riscv_opensbi_system.PNG" /></p>
<p>对于非虚拟化的系统，用户空间代码运行在U-Mode，内核运行在S-Mode，SBI运行在M-Mode。他们都使用system call来实现调用<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>。他们之间是怎样实现层层调用的呢？</p>
<p>RISCV架构中有如下规定：</p>
<blockquote>
<p>By default, all traps at any privilege level are handled in machine mode, though a machine-mode handler can redirect traps back to the appropriate level with the MRET instruction (Section 3.3.2). To increase performance, implementations can provide individual read/write bits within medeleg and mideleg to indicate that certain exceptions and interrupts should be processed directly by a lower privilege level. The machine exception delegation register (medeleg) and machine interrupt delegation register (mideleg) are MXLEN-bit read/write registers.</p>
</blockquote>
<p>也就是说，默认情况下，无论CPU当前处于哪种特权等级，发生的异常都会进入到machine mode，即跳转到mtvec寄存器所指向的异常处理函数中。但是为了提高性能，在CPU实现过程中可以提供medeleg和mideleg寄存器来把特定的异常和中断重定向到低特权等级。当在这两个寄存器设置了委托，特定的异常和中断就会直接通过低特权等级的tvec进入特定等级的异常处理函数。</p>
<p>内核正是通过这一点来实现工作在S态，并提供系统调用，用户App才能够通过ECALL指令直接陷入到内核，走内核的异常处理，而不是跳到SBI中。</p>
<p>OpenSBI中lib/sbi/sbi_hart.c的代码说明了这一点,CAUSE_USER_ECALL(用户态的系统调用)，以及PAGE_FAULT(必然也要有缺页异常以创建新的页表)都会被委托给S-mode。</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">delegate_traps</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbi_scratch</span><span class="w"> </span><span class="o">*</span><span class="n">scratch</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">hartid</span><span class="p">)</span>
<span class="p">{</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sbi_platform</span><span class="w"> </span><span class="o">*</span><span class="n">plat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sbi_platform_ptr</span><span class="p">(</span><span class="n">scratch</span><span class="p">);</span>
<span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">interrupts</span><span class="p">,</span><span class="w"> </span><span class="n">exceptions</span><span class="p">;</span>

<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">misa_extension</span><span class="p">(</span><span class="sc">&#39;S&#39;</span><span class="p">))</span>
<span class="w">  </span><span class="cm">/* No delegation possible as mideleg does not exist */</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w"> </span><span class="cm">/* Send M-mode interrupts and most exceptions to S-mode */</span>
<span class="w"> </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIP_SSIP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MIP_STIP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MIP_SEIP</span><span class="p">;</span>
<span class="w"> </span><span class="n">exceptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_MISALIGNED_FETCH</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_BREAKPOINT</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">       </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_USER_ECALL</span><span class="p">);</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sbi_platform_has_mfaults_delegation</span><span class="p">(</span><span class="n">plat</span><span class="p">))</span>
<span class="w">  </span><span class="n">exceptions</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_FETCH_PAGE_FAULT</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">         </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_LOAD_PAGE_FAULT</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">         </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_STORE_PAGE_FAULT</span><span class="p">);</span>

<span class="w"> </span><span class="cm">/*</span>
<span class="cm">  * If hypervisor extension available then we only handle hypervisor</span>
<span class="cm">  * calls (i.e. ecalls from HS-mode) in M-mode.</span>
<span class="cm">  *</span>
<span class="cm">  * The HS-mode will additionally handle supervisor calls (i.e. ecalls</span>
<span class="cm">  * from VS-mode), Guest page faults and Virtual interrupts.</span>
<span class="cm">  */</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">misa_extension</span><span class="p">(</span><span class="sc">&#39;H&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">exceptions</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_SUPERVISOR_ECALL</span><span class="p">);</span>
<span class="w">  </span><span class="n">exceptions</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_FETCH_GUEST_PAGE_FAULT</span><span class="p">);</span>
<span class="w">  </span><span class="n">exceptions</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_LOAD_GUEST_PAGE_FAULT</span><span class="p">);</span>
<span class="w">  </span><span class="n">exceptions</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_VIRTUAL_INST_FAULT</span><span class="p">);</span>
<span class="w">  </span><span class="n">exceptions</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CAUSE_STORE_GUEST_PAGE_FAULT</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="n">csr_write</span><span class="p">(</span><span class="n">CSR_MIDELEG</span><span class="p">,</span><span class="w"> </span><span class="n">interrupts</span><span class="p">);</span>
<span class="w"> </span><span class="n">csr_write</span><span class="p">(</span><span class="n">CSR_MEDELEG</span><span class="p">,</span><span class="w"> </span><span class="n">exceptions</span><span class="p">);</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>在内核代码arch/riscv/kernel/entry.S中的异常处理函数中也能够看到对系统调用的处理，EXC_SYSCALL即为CAUSE_USER_ECALL， pagefault的处理被放在了excp_vect_table中</p>
<div class="highlight"><pre><span></span><code><span class="mi">1</span><span class="o">:</span>
<span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="n">ret_from_exception</span>
<span class="w"> </span><span class="cm">/* Handle syscalls */</span>
<span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">EXC_SYSCALL</span>
<span class="w"> </span><span class="n">beq</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">handle_syscall</span>

<span class="w"> </span><span class="cm">/* Handle other exceptions */</span>
<span class="w"> </span><span class="n">slli</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">RISCV_LGPTR</span>
<span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">excp_vect_table</span>
<span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">excp_vect_table_end</span>
<span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="cm">/* pt_regs */</span>
<span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>
<span class="w"> </span><span class="cm">/* Check if exception code lies within bounds */</span>
<span class="w"> </span><span class="n">bgeu</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="mf">1f</span>
<span class="w"> </span><span class="n">REG_L</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="w"> </span><span class="n">jr</span><span class="w"> </span><span class="n">t0</span>
</code></pre></div>
<p>通过上面的描述，就理清楚了当内核工作在S模式，用户App为什么通过ECALL能够直接陷入到内核中进行系统调用的处理。</p>
<p>在内核中，可以通过SBI接口来享受SBI服务。内核中的sbi_ecall也是通过ECALL实现的。
SBI使用a7来传递SBI扩展ID(EID)，使用a6来传递SBI function ID(FID)。我们可以理解为EID是模块ID，每个模块下面有很多Function,通过FID来指定。
同时，使用a0, a1来返回错误码， ret.error 和 ret.value就是他们的值。</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">sbiret</span><span class="w"> </span><span class="n">sbi_ecall</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ext</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fid</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg0</span><span class="p">,</span>
<span class="w">   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg2</span><span class="p">,</span>
<span class="w">   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg3</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg4</span><span class="p">,</span>
<span class="w">   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg5</span><span class="p">)</span>
<span class="p">{</span>
<span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sbiret</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;a0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg0</span><span class="p">);</span>
<span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;a1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg1</span><span class="p">);</span>
<span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;a2&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg2</span><span class="p">);</span>
<span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a3</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;a3&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg3</span><span class="p">);</span>
<span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a4</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;a4&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg4</span><span class="p">);</span>
<span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a5</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;a5&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg5</span><span class="p">);</span>
<span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a6</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;a6&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">fid</span><span class="p">);</span>
<span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a7</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;a7&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">ext</span><span class="p">);</span>
<span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;ecall&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;+r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">a0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;+r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">a2</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">a3</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">a4</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">a5</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">a6</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">a7</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a0</span><span class="p">;</span>
<span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a1</span><span class="p">;</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sbi_ecall</span><span class="p">);</span>
</code></pre></div>
<p>下面列出这些EID</p>
<div class="highlight"><pre><span></span><code><span class="cp">#ifdef CONFIG_RISCV_SBI</span>
<span class="k">enum</span><span class="w"> </span><span class="n">sbi_ext_id</span><span class="w"> </span><span class="p">{</span>
<span class="cp">#ifdef CONFIG_RISCV_SBI_V01</span>
<span class="w"> </span><span class="n">SBI_EXT_0_1_SET_TIMER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_0_1_CONSOLE_PUTCHAR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_0_1_CONSOLE_GETCHAR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_0_1_CLEAR_IPI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x3</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_0_1_SEND_IPI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_0_1_REMOTE_FENCE_I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x5</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_0_1_REMOTE_SFENCE_VMA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x6</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_0_1_REMOTE_SFENCE_VMA_ASID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_0_1_SHUTDOWN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x8</span><span class="p">,</span>
<span class="w"> </span><span class="cp">#endif</span>
<span class="w"> </span><span class="n">SBI_EXT_BASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x54494D45</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_IPI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x735049</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_RFENCE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x52464E43</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_HSM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x48534D</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>比如SBI_EXT_BASE这个基础模块中，有如下Function</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="n">sbi_ext_base_fid</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="n">SBI_EXT_BASE_GET_SPEC_VERSION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_BASE_GET_IMP_ID</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_BASE_GET_IMP_VERSION</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_BASE_PROBE_EXT</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_BASE_GET_MVENDORID</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_BASE_GET_MARCHID</span><span class="p">,</span>
<span class="w"> </span><span class="n">SBI_EXT_BASE_GET_MIMPID</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>上述定义的内核支持的sbi_ecall, 他们会像下面这样进行封装</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">sbi_console_putchar</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
<span class="w"> </span><span class="n">sbi_ecall</span><span class="p">(</span><span class="n">SBI_EXT_0_1_CONSOLE_PUTCHAR</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sbi_console_putchar</span><span class="p">);</span>
</code></pre></div>
<p>虽然都是ECALL，但是这个ECALL是从S-mode发出，会触发CAUSE_SUPERVISOR_ECALL，这会使CPU陷入M-mode,进入到SBI设置的异常处理函数中。便可以执行SBI中的代码。
OpenSBI的firmware/fw_base.S中实现了异常处理，其中通过如下代码进入sbi_trap_handler</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nf">call</span><span class="w"> </span><span class="no">sbi_trap_handler</span>
</code></pre></div>
<p>在lib/sbi/sbi_trap.c的sbi_trap_handler中又通过确认CAUSE_SUPERVISOR_ECALL而进入sbi_ecall_handler</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">sbi_trap_handler</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbi_trap_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">ulong</span><span class="w"> </span><span class="n">mcause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">csr_read</span><span class="p">(</span><span class="n">CSR_MCAUSE</span><span class="p">);</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mcause</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">CAUSE_SUPERVISOR_ECALL</span><span class="p">:</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">CAUSE_HYPERVISOR_ECALL</span><span class="p">:</span>
<span class="w">    </span><span class="n">rc</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">sbi_ecall_handler</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ecall handler failed&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>具体的协议在lib/sbi/sbi_ecall.c的sbi_ecall_handler中实现</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">sbi_ecall_handler</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbi_trap_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sbi_ecall_extension</span><span class="w"> </span><span class="o">*</span><span class="n">ext</span><span class="p">;</span>
<span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">extension_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a7</span><span class="p">;</span>
<span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">func_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a6</span><span class="p">;</span>
<span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sbi_trap_info</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">out_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_0_1_spec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

<span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a0</span><span class="p">;</span>
<span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a1</span><span class="p">;</span>
<span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a2</span><span class="p">;</span>
<span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a3</span><span class="p">;</span>
<span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a4</span><span class="p">;</span>
<span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a5</span><span class="p">;</span>

<span class="w"> </span><span class="n">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sbi_ecall_find_extension</span><span class="p">(</span><span class="n">extension_id</span><span class="p">);</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ext</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">(</span><span class="n">extension_id</span><span class="p">,</span><span class="w"> </span><span class="n">func_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_val</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">extension_id</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">SBI_EXT_0_1_SET_TIMER</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="n">extension_id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">SBI_EXT_0_1_SHUTDOWN</span><span class="p">)</span>
<span class="w">   </span><span class="n">is_0_1_spec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SBI_ENOTSUPP</span><span class="p">;</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>如上就是整个SBI的工作机制。</p>
<h3 id="why-its-needed">why it's needed<a class="headerlink" href="#why-its-needed" title="Permanent link">&para;</a></h3>
<p>通过上述的分析，已经对SBI有了深入的了解。总结来看，因为又SBI的存在，内核不再需要关心SBI中涉及的这些底层的实现，只需要实现一套接口即可。
假如没有SBI,那么每一个厂家的CPU都需要在内核中对这些底层接口做不同的实现，显然，没有一个统一的厂商类型获取途径能够让内核来判断当前的设备应该匹配哪一套底层实现，这便只能要求我们编译不同的内核版本以匹配不同的CPU。这无疑会使得内核版本混乱，其实是让内核关心了它本不应该关心的东西。通过增加这一层，内核的可移植性便得到了提高。另一方面，从安全性上来讲，这种方式更加安全。</p>
<h2 id="opensbi_1">OpenSBI的实现<a class="headerlink" href="#opensbi_1" title="Permanent link">&para;</a></h2>
<blockquote>
<p>The goal of the OpenSBI project is to provide an open-source reference implementation of the RISC-V SBI specifications for platform-specific firmwares executing in M-mode (case 1 mentioned above). An OpenSBI implementation can be easily extended by RISC-V platform and system-on-chip vendors to fit a particular hardware configuration.</p>
</blockquote>
<h3 id="opensbi_2">假如我们设计OpenSBI<a class="headerlink" href="#opensbi_2" title="Permanent link">&para;</a></h3>
<p>在了解了what is SBI and why it's needed之后，我们再去分析一下OpenSBI是如何做到它描述中所讲的可扩展和定制性。这涉及到软件设计思想。在分析OpenSBI代码之前，思考一个问题，假如我们去设计OpenSBI，我们大致会怎么做？</p>
<p>大致罗列如下几点：</p>
<ul>
<li>软件至少应该包含启动代码，接口管理主体，加载并执行下一级软件等功能</li>
<li>为了能够支持不同厂商，必然要为厂商们创建一个目录，专门存放他们定制的内容</li>
<li>为了能够让每一个厂商都比较容易的添加自己特有的实现，SBI中规定的每一个接口都应该有一个默认实现，并且每个厂商都能够重写这个实现。</li>
<li>应该能够有机制来识别厂商是否支持某接口</li>
<li>Makefile应该要灵活可扩展，应该尽可能的不需要厂商修改Makefile主体</li>
<li>应该能够很好的解耦riscv的扩展指令集</li>
</ul>
<p>把上述几点实现，猜想应该大致能够实现一个满足扩展性和定制化的SBI框架。接下来就实际看一下OpenSBI的实现，他们设计的高明之处又在哪里。</p>
<h3 id="_2">实现<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>首先来看一下大致的目录结构，一个build目录用于构建，一个firmware目录存放了启动文件以及连接脚本，其中通过名称跟功能对应。include和lib是其核心实现，platform应该就是放置厂商定制化内容的目录。
整体一个Makefile搞定，没有借助编译框架。还有一个docs目录放置了一些说明文档，这非常有利于对整个软件关键部分的理解。</p>
<div class="highlight"><pre><span></span><code>.
├── build
│   ├── lib
│   └── platform
├── docs
├── firmware
│   ├── external_deps.mk
│   ├── fw_base.ldS
│   ├── fw_base.S
│   ├── fw_dynamic.elf.ldS
│   ├── fw_dynamic.S
│   ├── fw_jump.elf.ldS
│   ├── fw_jump.S
│   ├── fw_payload.elf.ldS
│   ├── fw_payload.S
│   ├── objects.mk
│   └── payloads
├── include
│   ├── sbi
│   └── sbi_utils
├── lib
│   ├── sbi
│   └── utils
├── Makefile
├── platform
│   ├── andes
│   ├── generic
│   ├── kendryte
│   ├── sifive
│   ├── template
│   └── thead
</code></pre></div>
<p>OpenSBI在lib目录下实现了通用的框架，将需要各个平台定制化的东西抽象成sbi_platform, 各个平台需要实例化这个结构。libsbi.a 和 libsbiutil.a 加上实例化的 sbi_platform 就是libplatsbi.a。再加上启动汇编和链接脚本，就组成了最终的固件。</p>
<div class="highlight"><pre><span></span><code>   --------------          ------------------
   |  libsbi.a  |    +     |  libsbiutil.a  |               platform-independent library
   --------------          ------------------
                     |                                                                    |- andes
                     |     ---------------------------      created by specific platform  |- sifive
                     |  +  |  sbi_platform instance  |    &lt;-------------------------------|- generic
                     |     ---------------------------                                    |- ......
                     |
                     V
      ----------------------------------
      |          libplatsbi.a          |
      ----------------------------------
                     |
                     |       ---------------------
                     |   +   |      firmware     |
                     |       ---------------------
                     V
          -----------------------
          |    final firmware   |
          -----------------------
</code></pre></div>
<p>OpenSBI维护了一个struct sbi_scratch， 它使用控制状态寄存器mscratch来保存这个结构的地址，struct sbi_platform 的地址可以在启动汇编中保存在sbi_scratch中。</p>
<h2 id="_3">参考资料<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>[<a href="https://www.thegoodpenguin.co.uk/blog/an-overview-of-opensbi/">https://www.thegoodpenguin.co.uk/blog/an-overview-of-opensbi/</a>]</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>官方SBI的spec文档的前两章对SBI做了比较详细的说明，剩下的几章为每一个接口的说明，可以粗略通读，然后作为工具书使用。&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
        <script src="../search/main.js"></script>
      
    
  </body>
</html>